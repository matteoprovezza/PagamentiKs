<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pagamenti</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .loading { color: blue; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Pagamenti - Visualizzazione Nomi Atleti</h1>
    
    <div id="status" class="loading">Caricamento in corso...</div>
    
    <table id="paymentsTable">
        <thead>
            <tr>
                <th>ID Pagamento</th>
                <th>Data</th>
                <th>Atleta (Nome Cognome)</th>
                <th>Importo</th>
                <th>Tipo Pagamento</th>
            </tr>
        </thead>
        <tbody id="paymentsBody">
            <tr>
                <td colspan="5" class="loading">Caricamento pagamenti...</td>
            </tr>
        </tbody>
    </table>

    <script>
        // API Client semplificato
        const API_BASE_URL = 'http://localhost:8080/api/v1';

        async function apiRequest(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        async function getPayments() {
            return await apiRequest('/pagamenti');
        }

        async function getAthleteById(id) {
            return await apiRequest(`/atleti/${id}`);
        }

        async function loadPaymentsWithAthleteNames() {
            const statusDiv = document.getElementById('status');
            const tbody = document.getElementById('paymentsBody');
            
            try {
                statusDiv.textContent = 'Caricamento pagamenti...';
                statusDiv.className = 'loading';
                
                // Carica i pagamenti
                const payments = await getPayments();
                console.log('Pagamenti caricati:', payments);
                
                if (!payments || payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="error">Nessun pagamento trovato</td></tr>';
                    statusDiv.textContent = 'Nessun pagamento trovato';
                    statusDiv.className = 'error';
                    return;
                }
                
                tbody.innerHTML = '';
                
                // Per ogni pagamento, ottieni i dati dell'atleta
                for (const payment of payments) {
                    const row = document.createElement('tr');
                    
                    let athleteName = 'N/D';
                    
                    if (payment.atletaId) {
                        try {
                            statusDiv.textContent = `Caricamento dati atleta ID: ${payment.atletaId}...`;
                            const athlete = await getAthleteById(payment.atletaId);
                            
                            if (athlete && athlete.nome && athlete.cognome) {
                                athleteName = `${athlete.nome} ${athlete.cognome}`;
                                console.log(`Atleta trovato per pagamento ${payment.id}:`, athleteName);
                            } else {
                                console.warn(`Dati atleta incompleti per ID: ${payment.atletaId}`, athlete);
                            }
                        } catch (error) {
                            console.error(`Errore nel caricare l'atleta ID: ${payment.atletaId}`, error);
                            athleteName = `Errore ID: ${payment.atletaId}`;
                        }
                    } else {
                        console.warn('Pagamento senza atletaId:', payment);
                    }
                    
                    row.innerHTML = `
                        <td>${payment.id}</td>
                        <td>${payment.data || 'N/D'}</td>
                        <td><strong>${athleteName}</strong></td>
                        <td>€${payment.importo || 'N/D'}</td>
                        <td>${payment.tipoPagamento || 'N/D'}</td>
                    `;
                    
                    tbody.appendChild(row);
                }
                
                statusDiv.textContent = `Caricati ${payments.length} pagamenti con successo!`;
                statusDiv.className = 'success';
                
            } catch (error) {
                console.error('Errore generale:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="error">Errore nel caricamento dei pagamenti</td></tr>';
                statusDiv.textContent = `Errore: ${error.message}`;
                statusDiv.className = 'error';
            }
        }

        // Carica i dati quando la pagina è pronta
        document.addEventListener('DOMContentLoaded', loadPaymentsWithAthleteNames);
    </script>
</body>
</html>
